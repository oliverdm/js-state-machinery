(function(h){function d(a,b,c){this._states=f.Array.isArray(a)?a:[];this._context="[object Object]"===Object.prototype.toString.call(b)?b:{};this._activeState=null;this._listeners=[];this._opts={debug:!1};"[object Object]"===Object.prototype.toString.call(c)&&f.Object.assign(this._opts,c)}function g(a,b){this._name=a;this._opts={states:[],transitions:[],onEnter:null,onExit:null};"[object Object]"===Object.prototype.toString.call(b)&&f.Object.assign(this._opts,b)}function m(a,b,c){this._type=a;this._targetState=
b;this._opts={guard:null,delay:-1,stopPropagation:!1,stopImmediatePropagation:!1};"[object Object]"===Object.prototype.toString.call(c)&&f.Object.assign(this._opts,c)}function l(a,b,c){this.type=a;this.activeState=b;this.context=c;this.delay=-1;this.cancelled=!1;this.targetState=null}var f={Array:{isArray:function(a){return Array.isArray?Array.isArray(a):"[object Array]"===Object.prototype.toString.call(a)}},Number:{isInteger:function(a){return Number.isInteger?Number.isInteger(a):"number"===typeof a&&
isFinite(a)&&Math.floor(a)===a}},Object:{assign:function(){var a=Array.prototype.slice.call(arguments);if(!a.length||!a[0])throw new TypeError("Cannot convert first argument to object");if(Object.assign)return Object.assign.apply(a[0],a);for(var b=a[0],c=1,e=a.length;c<e;c++){var d=a[c];Object.keys(d).forEach(function(a){b[a]=d[a]})}return b}}};Object.defineProperty(d.prototype,"states",{get:function(){return this._states}});Object.defineProperty(d.prototype,"activeState",{get:function(){return this._collapseStateName(this._activeState)}});
d.prototype._log=function(){this._opts.debug&&console.log.apply(console,arguments)};d.prototype._warn=function(){this._opts.debug&&console.warn.apply(console,arguments)};d.prototype._registerListener=function(a,b){a in this._listeners||(this._listeners[a]=[]);-1===this._listeners[a].indexOf(b)&&this._listeners[a].push(b)};d.prototype._removeListener=function(a,b){if(a in this._listeners){var c=this._listeners[a].indexOf(b);-1!==c&&this._listeners[a].splice(c,1)}};d.prototype._invokeListeners=function(a){var b=
Array.prototype.slice.call(arguments,1);a in this._listeners&&this._listeners[a].forEach(function(a){a.apply(a,b)})};d.prototype.on=function(a,b){if("[object String]"===Object.prototype.toString.call(a)&&"[object Function]"===Object.prototype.toString.call(b))return this._registerListener(a,b),{cancel:function(){this._removeListener(a,b)}.bind(this)}};d.prototype._resolveStateName=function(a,b,c){b="undefined"===typeof b?this._states:b;c="undefined"===typeof c?[]:c;if(a&&"[object String]"===Object.prototype.toString.call(a)){a=
a.split(".");for(var e=0,d=b.length;e<d;e++)if(b[e]._name===a[0])return c.push(b[e]),1===a.length?c:this._resolveStateName(a.slice(1).join("."),b[e]._children(),c)}return[]};d.prototype._collapseStateName=function(a){var b=[];if(f.Array.isArray(a)){var c=null;a.forEach(function(a){if(c&&-1===c._children().indexOf(a))throw Error('State "'+a._name+'" must be a child of "'+c._name+'"');b.push(a._name);c=a})}return b.join(".")};d.prototype._mergeContext=function(a){return f.Object.assign({},this._context,
"[object Object]"===Object.prototype.toString.call(a)?a:{})};d.prototype._changeActiveState=function(a){var b=this._collapseStateName(this._activeState),c=this._collapseStateName(a);this._activeState=a;this._invokeListeners("change",{oldState:b,newState:c})};d.prototype._invokeStateHook=function(a,b,c,e){function d(){if(f<g)b[f][a](c,function(){f++;d()});else"[object Function]"===Object.prototype.toString.call(e)&&e(b)}var f=0,g=b.length;d()};d.prototype.init=function(a,b,c){if(!a||"[object String]"!==
Object.prototype.toString.call(a))throw Error("Invalid state name: "+a);if(this._activeState)throw Error("StateMachine already initialized");0<=["function","undefined"].indexOf(typeof b)&&(c=b,b={});var e=this._resolveStateName(a);if(!e.length)throw Error("State not found: "+a);this._log("INIT STATE:",a);a=new l("init","",this._mergeContext(b));var d=this;this._invokeStateHook("_enter",e,a,function(){d._changeActiveState(e);c&&c()})};d.prototype.fireStateEvent=function(a,b){if(!a||"[object String]"!==
Object.prototype.toString.call(a))throw Error("Invalid event type: "+a);if(f.Array.isArray(this._activeState)&&this._activeState.length){var c=new l(a,this._collapseStateName(this._activeState),this._mergeContext(b)),e=this._activeState.slice(),d=this._collapseStateName(e);e.reverse();e.some(function(a){if(c.cancelled)return!0;a._handleStateEvent(c)});var g;c.targetState&&(g=this._resolveStateName(c.targetState));if(f.Array.isArray(g)&&g.length){var h=function(){k._log("EXIT STATE:",d);k._invokeStateHook("_exit",
e,c,function(){k._log("ENTER STATE:",k._collapseStateName(g));k._invokeStateHook("_enter",g,c,k._changeActiveState.bind(k))})},k=this;this._activeState=null;0===c.delay?(this._log("ASYNC TRANSITION",0),requestAnimationFrame(h)):0<c.delay?(this._log("ASYNC TRANSITION",c.delay),setTimeout(h,c.delay)):h()}else this._log("NO TARGET STATE:",c.targetState)}else this._warn("NO CURRENT STATE. EVENT DROPPED:",a)};g.prototype._children=function(){return f.Array.isArray(this._opts.states)?this._opts.states:
[]};g.prototype._transitionsForType=function(a){var b=this._opts.transitions,c=[];if(!f.Array.isArray(b))return c;b.forEach(function(b){a===b._type?c.push(b):f.Array.isArray(b._type)&&-1!==b._type.indexOf(a)&&c.push(b)});return c};g.prototype._handleStateEvent=function(a){this._transitionsForType(a.type).some(function(b){b._test(a)&&a.transition(b._targetState,b._opts.delay);b._opts.stopPropagation&&a.stopPropagation();if(b._opts.stopImmediatePropagation)return a.stopPropagation(),!0})};g.prototype._enter=
function(a,b){var c=this._opts.onEnter;if("[object Function]"===Object.prototype.toString.call(c)){var d=[a.context,a.type,a.activeState];3<c.length?(d.push(b),c.apply(c,d)):(c.apply(c,d),b())}else b()};g.prototype._exit=function(a,b){var c=this._opts.onExit;if("[object Function]"===Object.prototype.toString.call(c)){var d=[a.context,a.type,a.targetState];3<c.length?(d.push(b),c.apply(c,d)):(c.apply(c,d),b())}else b()};m.prototype._test=function(a){var b=this._opts.guard;return"[object Function]"!==
Object.prototype.toString.call(b)?!0:b(a.context,a.type,a.activeState)?!0:!1};l.prototype.transition=function(a,b){this.targetState=a;f.Number.isInteger(b)&&(this.delay=b)};l.prototype.stopPropagation=function(){this.cancelled=!0};h.FsmMachine=d;h.FsmState=g;h.FsmTransition=m;h.FsmEvent=l})(window);
